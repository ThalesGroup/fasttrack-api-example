# Example Project Application for iOS

## Introduction

FastTrack Example is an iOS sample application designed to demonstrate
the basics of using mobile protector and mobile messenger features 
based on the FastTrack API.

The application demonstrates the following FastTrack features:

* Mobile Protector
    * How to create a token device.
    * How to generate OTP by PIN.
    * How to change the PIN of token device.
    * How to activate and deactivate token device for Biometric usage.
    * How to generate OTP by Biometric.
    * How to list token devices.
    * How to remove token devices.
* Mobile Messenger
    * How register a client to OOB server.
    * How to fetch a message.
    * How to acknowledge a message.
    * How to respond to a Transaction Verification message.
    * How to respond to a Transaction Signing message using OCRA OTP.
    * How to unregister the client.

## Prerequisites

* macOS development platform
* Xcode 9.1+ or later
* FastTrack framework
* Ezio Mobile framework

## Setup and open the project

In Xcode:

* File -> Open -> FastTrackExample.xcodeproj
* Add the FastTrack.framework path in the project's “Framework Search Paths” list.
* Add the FastTrack.framework in the project's "Link Binary with Libraries" list.
* Add the EzioMobile.framework path in the project's “Framework Search Paths” list.
* Add the EzioMobile.framework in the project's "Link Binary with Libraries" list.

## Configure the App

The application will not work as provided.  It must first be setup to be
provisioned with the user credentials.  To enable this, perform the following
steps:

* Perform an "Allocate Application" operation in the EPS to get the PIN and
  registration code.  See Appendix for how to do this in a test environemnt.
* Edit FastTrackExample.swift to add the Activation code provided by Thales.
* Edit ProtectorConfigurations.swift to update your EPS settings, etc.
* Edit MessengerConfigurations.swift to update messenger server settings, etc.

## Run the Example App

It is recommended to uninstall all related example applications installed
previously before running this App, or removed the tokens generated by those Apps.

### Mobile Protector
1. Retrieved the registration code and PIN from EPS through enrollment process.
2. Create a token with entering the registration code and pressing `Provision` button.
   After the token is created, the token name will appear on the drop down list.
3. Press `OTP with PIN` button to generate OTP by using PIN.
4. Change the PIN with user PIN with pressing `Change PIN` button.
5. To be able to generate the OTP using Biometric, press `Activate SystemBiometric` button. The biometric fingerprint is required be enrolled on the device. Press `OTP with SystemBiometric` afterwards.
6. Press `Activate SystemBiometric` to disable the OTP generation using System Biometric.
7. Press `List TokenDevice` to list all the token device available on the device.
8. To remove the token, press `Delete TokenDevice`. To be able to generate the OTP again, it is required to do another provisoning with different registration code.

### Mobile Messenger
1. Do the registration on OOB Server to retrieved the an OOB registration code.
2. Register the client with entering the OOB registration code.
3. Dispatch a message from Bank Server to OOB Server.
4. Fetch the message

    There are 3 types of messages which could be received by the client on this example application, 
    for more details refer to OOB Integration Guide :

    *  Generic message: A normal message. This message will ask the user whether to acknowledge or ignore it.
    *  Transaction verify message: A confirmation message to ask the user whether to accept or reject the transaction.
    *  Transaction signing message: A signing message, similar with Trasaction verify message but when user accept the message,
       user is required to enter the pin of the token device and the otp will be generated and send to server.
       This message type is required to have an OCRA Token Device available. It could be done by doing OCRA provisioning on Mobile Protector.
    
5. Unregister the client from OOB Server

## Appendix

1. EPS Enrollment

   NOTE: This only serves as a quick reference.  See the EPS 2.X Integration Guide for further details.

   The following URL can be used to request the EPS to enroll the user with a new device.  

   ``` url
   https://localhost/enroller/api/enrollment/oath/enroll
   ```

   However, the following must be modified:

   * The path up to `https://localhost/` must be changed to point to your EPS.

   The following JSON payload must be sent as the data portion of the HTTP POST.

   ``` json
   {
        "format": "5.0",
        "authorization": {
            "userId": "your_user_id"
        },
        "body": {
            "keyProtections": [
                {
                    "name": "pin"
                }
            ],
            "tokens": [
                {
                    "name": "seed",
                    "expirationDate": "2032-01-01T12:00:00Z",
                    "activationState": "ACTIVE",
                    "manufacturerUniqueId": "your_8_digit_manufacturer_id",
                    "extension": {
                        "authserver.sas.oath.key": "your_oath_key_in_base64",
                        "authserver.sas.oathDeviceType": "your_oath_device_type_in_base64",
                        "authserver.sas.device.type": "your_device_type_in_base64",
                        "authserver.sas.oath.policy": "your_oath_policy_in_base64"
                    }
                }
            ]
        }
    }
   ```



   However, the following must be modified:

   * userId - The name of the user to enroll
   * userTokenId - The token ID (must be unique for the user)
   * domain - The EPS domain for OATH TOTP
   * key (see externalProvisioningMeta -> propertyEntry) - Additional provisioning information depending on the verification server. See the EPS 2.X Integration Guide for further details.
   * value (see externalProvisioningMeta -> propertyEntry) - Additional provisioning information depending on the verification server. See the EPS 2.X Integration Guide for further details.

   Also note that

   * The `Content-Type` must be set to `application/xml`
   * The response will contain the PIN and registration code if successful.

   Example:

   ``` bash
   wget --header="Content-Type: application/xml" --post-data "<data>" <url> -O -
   ```

2. OOB Server Registration

   NOTE: This only serves as a quick reference.  See the OOBS Integration Guide for further details.

   The following URL can be used to request the OOBS to register the user with a new device.  

   ``` html
   https://localhost/oobs-dispatcher/domains/default/users/my-user/applications/oobsTest/register
   ```

   However, the following must be modified:

   * The path up to `https://localhost/` must be changed to point to your OOBS.
   * Make sure the domain('default') and the application('oobsTest') has been properly setup on server. 

   Please refer to the OOBS integration guide for more details. If the domain name and application name are changed, 'default' and 'oobsTest' must be replaced with the new domain name and application name respectively.

   The following XML payload must be sent as the data portion of the HTTP POST.

   ``` xml
   <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>
    <RegisterRequest xmlns=\"http://gemalto.com/ipms/dispatcher/api/transport\" >
     <registrationSecurityMethod>REG_CODE</registrationSecurityMethod>
     <registrationCode>TODO</registrationCode>
     <validityPeriodSecs>600</validityPeriodSecs>
     <notificationProfiles />
    </RegisterRequest>
   ```

   However, the following must be modified:
   
   * registrationCode - The registration code. OOBS should return the same registration code if request succeed.
   * The "Content-Type" must be set to "application/xml"
   * The "BASIC Authorization" is used.
   * The response will contain the registration code and client Id if successful.

   Example:

   ``` bash
    wget --header="Authorization: Basic XXXXXXXXXXXXXXXX" --header="Content-Type: application/xml" --post-data "<data>" <url> -O -
   ```

   *XXXXXXXXXXXXXXXX should be replaced with your "user name:password" String in base-64 format.